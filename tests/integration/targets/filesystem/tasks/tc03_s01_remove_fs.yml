---
#######################################
# Setup Tasks
#######################################
- name: "SETUP: fetch LVM facts"
  lvm_facts:
    name: all
    component: all
  register: facts
- debug: var=facts

- name: "SETUP: check if it is second run"
  shell: ls /tmp/tc03_s01_remove_fs_second_run || echo "first run"
  register: check_run

- name: "SETUP: create volume group"
  lvg:
    state: present
    vg_name: "{{ vg_name }}"
    pvs: "{{ pv_list }}"
    force: "{{ force }}"
  when:
  - facts.ansible_facts.LVM.VGs.{{ vg_name }} is not defined
  - check_run.stdout.find( "first run" ) != -1

- name: "SETUP: create a logical volume"
  lvol:
    state: present
    vg: "{{ vg_name }}"
    lv: "{{ lv_name }}"
    size: "{{ lv_size }}"
    lv_type: "{{ lv_type }}"
  register: results
  when:
  - facts.ansible_facts.LVM.LVs.{{ lv_name }} is not defined
  - check_run.stdout.find( "first run" ) != -1

- name: "SETUP: create a filesystem"
  filesystem:
    state: present
    device: "{{ lv_name }}"
    filesystem: "{{ fs_mnt }}"
    fs_type: "{{ fs_type }}"
  when:
  - facts.ansible_facts.LVM.LVs.{{ lv_name }} is not defined
  - check_run.stdout.find( "first run" ) != -1

#######################################
# Actual Task To Be Tested
#######################################
- name: "TC03_S01: delete filesystem"
  filesystem:
    state: absent
    filesystem: "{{ fs_mnt }}"
    rm_mount_point: "{{ rm_mnt_pt }}"
  register: results
- debug: var=results

- name: "TC03_S01_ASSERT1: expected results - first run"
  assert:
    that:
    - results.msg.find( "Filesystem '{{ fs_mnt }}' has been removed" ) != -1
    - results.cmd.find( "rmfs" ) != -1
  when:
  - results is changed

- name: "SETUP: make sure filesystem is not recreated in second run setup"
  command: touch /tmp/tc03_s01_remove_fs_second_run
  when:
  - results is changed

- name: "TC03_S01_ASSERT2: expected results - second run"
  assert:
    that:
    - results.msg.find( "No action needed as filesystem does not exist" ) != -1
  when:
  - results is not changed

- name: "SETUP: cleanup temporary file /tmp/tc03_s01_remove_fs_second_run"
  command: rm /tmp/tc03_s01_remove_fs_second_run
  when:
  - results is not changed

#######################################
# Teardown Tasks
#######################################
- name: "TEARDOWN: delete volume group"
  lvg:
    state: absent
    vg_name: "{{ vg_name }}"
    delete_lvs: "{{ delete_lvs }}"
  when:
  - results is not changed
