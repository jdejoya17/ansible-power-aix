---
#######################################
# Setup Tasks
#######################################
- name: "SETUP: create user"
  user:
    state: present
    name: "{{ name_v }}"
    change_passwd_on_login: "{{ change_passwd_on_login_v }}"
    password: "{{ hashed_password_v1 }}"

- name: "SETUP: make sure remote login is enabled"
  user:
    state: modify
    name: "{{ name_v }}"
    attributes: "{{ attributes_v3 }}"

- name: "SETUP: fetch hostname"
  shell: hostname
  register: host
  changed_when: false

#######################################
# Actual Task To Be Tested
#######################################
- name: "TC02_S02: change user password - hashed"
  user:
    state: modify 
    name: "{{ name_v }}"
    change_passwd_on_login: "{{ change_passwd_on_login_v }}"
    password: "{{ hashed_password_v2 }}"
  register: results
- debug: var=results

- name: "SETUP: test login"
  expect:
    command: ssh "{{ name_v }}"@"{{ host.stdout }}" "echo 'logged in'"
    responses:
      (?i)password: "{{ password_v2 }}"
  delegate_to: localhost
  ignore_errors: true
  register: login_result
- debug: var=login_result

- name: "TC02_S02_ASSERT: expected results - first/second run"
  assert:
    that:
    - results.msg.find( "Password is set successfully" ) != -1
    - login_result.stdout.find( "logged in" ) != -1
    - login_result.rc == 0
  when:
  - results is changed

#######################################
# Teardown Tasks
#######################################
- name: "TEARDOWN: remove user"
  user:
    state: absent
    name: "{{ name_v }}"
    change_passwd_on_login: "{{ change_passwd_on_login_v }}"
  when:
  - results is changed
