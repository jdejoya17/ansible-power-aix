---
#######################################
# Setup Tasks
#######################################
- name: "SETUP: fetch hostname"
  shell: hostname
  register: host
  changed_when: false

#######################################
# Actual Task To Be Tested
#######################################
- name: "TC01_S01: create user"
  user:
    state: present
    name: "{{ name_v }}"
    change_passwd_on_login: "{{ change_passwd_on_login_v }}"
    password: "{{ password_v1 }}"
  register: results
- debug: var=results

- name: "SETUP: test login"
  expect:
    command: ssh "{{ name_v }}"@"{{ host.stdout }}" "echo 'logged in'"
    responses:
      (?i)password: "{{ password_v1 }}"
  delegate_to: localhost
  register: login_result
  ignore_errors: true
- debug: var=login_result

# TODO: this test case must be updated once the user hash
# password issue is resolved
- name: "TC01_S01_ASSERT1: expected results - first run"
  assert:
    that:
    - login_result is failed
    # - results.msg.find( "created SUCCESSFULLY" ) != -1
    # - login_result.stdout.find( "logged in" ) != -1
    # - login_result.rc == 0
  when:
  - results is changed

# - name: "TC01_S01_ASSERT2: expected results - second run"
#   assert:
#     that:
#     - results.msg.find( "already exists" ) != -1
#     - login_result.stdout.find( "logged in" ) != -1
#     - login_result.rc == 0
#   when:
#   - results is not changed
